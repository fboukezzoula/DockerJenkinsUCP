Pour créer automatiquement un utilisateur avec son répertoire personnel lors de la connexion SSH, vous pouvez utiliser PAM (Pluggable Authentication Module) avec les rpms pam_script sous CentOS/RHEL. Vous avez déjà la bonne idée en ajoutant la directive "auth optional /usr/lib64/security/pam_script.so" et en créant un script dans le répertoire /etc/pam-script.d. Voici les étapes pour le faire :

Assurez-vous d'installer les paquets nécessaires si ce n'est pas déjà fait :

Copy code
sudo yum install pam_script
Créez un script PAM pour créer l'utilisateur et son répertoire personnel. Par exemple, créez un fichier dans /etc/pam-script.d, par exemple /etc/pam-script.d/create_user, avec le contenu suivant :

bash
Copy code
#!/bin/bash

# Récupérer le nom d'utilisateur de l'environnement
USERNAME="$PAM_USER"

# Vérifier si l'utilisateur existe
if id "$USERNAME" &>/dev/null; then
    # L'utilisateur existe déjà
    exit 0
else
    # Créer l'utilisateur avec son répertoire personnel
    useradd -m "$USERNAME"
    exit 0
fi
Assurez-vous que le script est exécutable avec la commande :

bash
Copy code
sudo chmod +x /etc/pam-script.d/create_user
Modifiez votre configuration PAM pour SSH. Ouvrez le fichier /etc/pam.d/sshd avec un éditeur de texte (en utilisant sudo) et ajoutez la ligne suivante à la fin de la section "auth":

bash
Copy code
auth optional /usr/lib64/security/pam_script.so
Assurez-vous que le fichier /etc/pam.d/sshd ressemble à ceci :

text
Copy code
# /etc/pam.d/sshd
auth       required     pam_sepermit.so
auth       substack     password-auth
auth       include      postlogin
auth optional /usr/lib64/security/pam_script.so
Assurez-vous que votre serveur SSH est configuré pour autoriser l'authentification par clé SSH.

Testez votre configuration en vous déconnectant du serveur SSH (si vous êtes déjà connecté) et en vous reconnectant. Lorsque l'utilisateur se connectera via SSH, le script PAM vérifiera s'il existe déjà et le créera si nécessaire.

Veuillez noter que cette méthode est basée sur PAM et peut nécessiter des ajustements en fonction de votre configuration spécifique. Assurez-vous de prendre des précautions de sécurité appropriées, car la création automatique d'utilisateurs peut présenter des risques potentiels.

L'erreur "input_userauth_request: invalid user USERNAME [preauth]" indique que SSH n'accepte pas le nom d'utilisateur que vous utilisez lors de la tentative de connexion. Vous devez vous assurer que le nom d'utilisateur que vous utilisez est correct et qu'il correspond au nom d'utilisateur que vous avez configuré dans le script PAM. Assurez-vous également que vous utilisez la clé SSH correspondante pour cet utilisateur.

Voici quelques étapes à suivre pour résoudre ce problème :

Vérifiez que le nom d'utilisateur que vous utilisez lors de la connexion SSH correspond exactement au nom d'utilisateur que vous avez configuré dans le script PAM. Les noms d'utilisateurs sont sensibles à la casse, donc assurez-vous qu'ils correspondent exactement.

Assurez-vous que le script PAM que vous avez créé (dans /etc/pam-script.d/create_user) est correctement configuré pour créer un utilisateur avec le même nom que celui que vous utilisez pour vous connecter. Vérifiez que la variable USERNAME dans le script est correcte.

Vérifiez que la clé publique SSH correspondant à l'utilisateur est présente dans le répertoire ~/.ssh/authorized_keys du répertoire personnel de l'utilisateur. Assurez-vous que le nom de fichier et le chemin de la clé publique correspondent au nom d'utilisateur que vous utilisez pour vous connecter.

Assurez-vous que le répertoire personnel de l'utilisateur est créé lors de la création de l'utilisateur. Le script PAM que vous avez configuré (/etc/pam-script.d/create_user) devrait créer un répertoire personnel avec la commande useradd -m "$USERNAME". Assurez-vous que cette commande est correcte.

Redémarrez le service SSH pour vous assurer que les modifications apportées à la configuration PAM sont prises en compte :

Copy code
sudo systemctl restart sshd
Après avoir vérifié ces points, essayez de vous connecter à nouveau en utilisant le nom d'utilisateur que vous avez configuré dans le script PAM. Si le problème persiste, assurez-vous de fournir les détails de votre configuration SSH et du script PAM pour une assistance plus spécifique.
