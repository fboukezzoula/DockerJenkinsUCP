if [[ -n "$ssh_proxy_port" && "$ssh_proxy_port" != "-1" && -n "$dev_hostname" ]]; then

#!/bin/bash

consul_url="https://monconsul.intra"
consul_prefix="devs"
consul_token="votre_token"  # Remplacez par votre token Consul

# Récupérer la liste des clés sous le préfixe
keys=$(curl -s -H "Authorization: Bearer $consul_token" "$consul_url/v1/kv/$consul_prefix?keys")

# Parcourir les clés
for key in $keys; do
  # Récupérer les données JSON associées à la clé
  data=$(curl -s -H "Authorization: Bearer $consul_token" "$consul_url/v1/kv$key")
  
  # Extraire le nom du développeur de la clé (par exemple, dev1hostname)
  dev_hostname=$(basename $key)
  
  # Extraire le port SSH proxy du JSON
  ssh_proxy_port=$(echo "$data" | jq -r '.[0].Value' | base64 -d | jq -r '.ssh_proxy_port')
  
  if [[ -n "$ssh_proxy_port" && -n "$dev_hostname" ]]; then
    # Construire la commande socat
    socat_cmd="socat TCP-LISTEN:$ssh_proxy_port,fork,reuseaddr TCP:$dev_hostname:22"
    
    # Exécuter la commande socat en arrière-plan
    $socat_cmd &
    
    echo "Commande socat exécutée pour le port $ssh_proxy_port vers $dev_hostname"
  fi
done
